{% extends "base.html" %}

{% block container_class %}container-fluid px-4{% endblock %}

{% block content %}
<style>
    /* --- CORE STYLES --- */
    :root { --text-dark: #1f2937; --text-muted: #6b7280; }
    .monitor-header { background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px 30px; margin-bottom: 25px; border: 1px solid #e5e7eb; }
    .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; }
    .stat-value { font-size: 1.125rem; font-weight: 700; color: var(--text-dark); }
    .cam-column { background: #fff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; height: 100%; display: flex; flex-direction: column; }
    .cam-header { padding: 20px 25px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
    .cam-body { padding: 20px; flex-grow: 1; background-color: #f9fafb; }
    .section-header { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; display: flex; justify-content: space-between; }
    .section-header.completed { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .section-header.pending { background-color: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; }
    .part-card { background: white; border-radius: 8px; padding: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; min-height: 90px; }
    .part-card.pending { border-left: 5px solid #6366f1; }
    .part-card.completed { background-color: #ecfdf5; border: 1px solid #10b981; border-left: 5px solid #10b981; }
    .order-badge { position: absolute; top: 0; left: 0; background: #10b981; color: white; font-size: 0.75rem; font-weight: 800; padding: 2px 8px; border-bottom-right-radius: 8px; }
    .last-detected-badge { position: absolute; bottom: 0; right: 0; background: #32325d; color: white; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; padding: 3px 10px; border-top-left-radius: 8px; animation: flashBadge 1s infinite alternate; }
    @keyframes flashBadge { from { opacity: 0.8; } to { opacity: 1; } }
    .h-100-card { height: 100%; min-height: 70vh; }
    .btn-cam-history { padding: 4px 10px; font-size: 0.8rem; border-radius: 20px; font-weight: bold; }

    /* --- SIDE PANEL POPUPS (CAM 1 & CAM 2) --- */
    .side-popup { 
        display: none; /* Hidden by default */
        position: fixed; 
        top: 50%; 
        transform: translateY(-50%);
        width: 48vw; 
        height: 95vh; 
        border-radius: 20px; 
        box-shadow: 0 25px 80px rgba(0,0,0,0.6); 
        z-index: 10000; 
        padding: 20px;
        flex-direction: column; 
        justify-content: space-between;
    }
    #overlay-cam1 { left: 1vw; right: auto; }
    #overlay-cam2 { right: 1vw; left: auto; }

    /* Themes */
    .theme-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: 2px solid #a7f3d0; }
    .theme-green .popup-icon { color: white; }
    .theme-green .popup-badge { background-color: white; color: #059669; }
    .theme-dark-green { background: linear-gradient(135deg, #065f46 0%, #047857 100%); color: white; border: 2px solid #34d399; }
    .theme-dark-green .popup-icon { color: #34d399; }
    .theme-dark-green .popup-badge { background-color: #34d399; color: #064e3b; }
    .theme-yellow { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: 2px solid #fde68a; }
    .theme-yellow .popup-icon { color: #fffbeb; }
    .theme-yellow .popup-badge { background-color: #fffbeb; color: #b45309; }

    .popup-img-container {
        flex-grow: 1; width: 100%; background-color: white; border-radius: 15px;
        display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 15px; min-height: 40vh; 
    }
    .popup-img-container img { width: 100%; height: 100%; object-fit: contain; }

    /* --- GLOBAL RED SCREEN --- */
    #kit-error-overlay { 
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: rgba(220, 38, 38, 0.98); z-index: 20000; 
        flex-direction: column; align-items: center; justify-content: center; text-align: center; 
    }
    .error-card { background: white; color: #333; padding: 30px; border-radius: 12px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); max-width: 600px; width: 90%; text-align: left; }
    .reason-select { border: 2px solid #dc2626; padding: 10px; font-size: 1.1rem; border-radius: 8px; width: 100%; margin-bottom: 20px; }

    /* --- GLOBAL JOB COMPLETE --- */
    #job-completion-overlay { 
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: #1e3a8a; color: white; z-index: 20001; 
        flex-direction: column; align-items: center; justify-content: center; text-align: center; 
    }
    .blink-active { animation: blinker 1s linear infinite; }
    @keyframes blinker { 50% { opacity: 0.3; } }

    /* --- HISTORY & ZOOM STYLES --- */
    .kit-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 15px; padding: 10px; }
    .kit-cell { aspect-ratio: 1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.2rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 2px solid transparent; color: white; }
    .kit-cell:hover { transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .kit-green { background-color: #10b981; border-color: #059669; }
    .kit-yellow { background-color: #f59e0b; border-color: #d97706; }
    .kit-red { background-color: #ef4444; border-color: #b91c1c; }
    .kit-blue { background-color: #3b82f6; border-color: #2563eb; animation: pulse 2s infinite; }
    .kit-grey { background-color: #e5e7eb; color: #9ca3af; border-color: #d1d5db; cursor: default; }

    /* History Images */
    .history-card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; height: 100%; display: flex; flex-direction: column; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .history-card-header { padding: 10px 15px; background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
    .history-img-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; padding: 15px; }
    .history-img-item { position: relative; aspect-ratio: 4/3; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; cursor: zoom-in; transition: transform 0.2s, box-shadow 0.2s; }
    .history-img-item:hover { transform: scale(1.03); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: #10b981; }
    .history-img-item img { width: 100%; height: 100%; object-fit: cover; }
    .img-badge { position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.75); color: white; padding: 3px 8px; font-size: 0.65rem; font-weight: bold; border-bottom-right-radius: 8px; backdrop-filter: blur(2px); }

    /* Zoom Overlay */
    #zoom-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30000; align-items: center; justify-content: center; cursor: zoom-out; animation: fadeIn 0.2s ease-in-out; }
    #zoom-img { max-width: 95vw; max-height: 95vh; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
</style>

<div id="overlay-cam1" class="side-popup theme-green"></div>
<div id="overlay-cam2" class="side-popup theme-green"></div>

<div id="kit-error-overlay">
    <div class="error-card">
        <div class="text-center mb-2"><i class="fas fa-exclamation-circle fa-4x text-danger"></i></div>
        <h2 class="fw-bold text-danger text-center mb-1" id="err-title">VALIDATION FAILED</h2>
        <h5 class="text-muted text-center mb-4" id="err-subtitle">Action Required</h5>
        <div id="err-content" class="mb-4 bg-light p-3 rounded border"></div>
        <label class="fw-bold text-secondary mb-1">Select Resolution Reason:</label>
        <select class="form-select reason-select" id="err-reason">
            <option value="" disabled selected>-- Choose Action --</option>
        </select>
        <button class="btn btn-danger w-100 btn-lg fw-bold" onclick="submitResolution()">CONFIRM & PROCEED <i class="fas fa-arrow-right ms-2"></i></button>
    </div>
</div>

<div id="job-completion-overlay">
    <div class="blink-active">
        <i class="fas fa-flag-checkered fa-6x text-warning mb-4"></i>
        <h1 class="fw-bold display-1 text-white">JOB COMPLETED</h1>
        <h3 class="text-white opacity-75 text-uppercase">All Kits Packed Successfully!</h3>
        <div class="mt-5">
            <div class="spinner-border text-light me-2" role="status" style="width: 1.5rem; height: 1.5rem;"></div>
            <span class="text-white">Redirecting to Dashboard...</span>
        </div>
    </div>
</div>

<div id="zoom-overlay" onclick="closeZoom()"><img id="zoom-img" src=""></div>

<div class="monitor-header">
    <div class="row align-items-center">
        <div class="col-md-3 d-flex align-items-center gap-3">
            <a href="{{ url_for('kitting.index') }}" class="btn btn-outline-secondary btn-sm border-0 fw-bold"><i class="fas fa-arrow-left me-1"></i> Back</a>
            <span class="badge rounded-pill bg-success px-3 py-2 text-uppercase">{{ activity.status }}</span>
        </div>
        <div class="col-md-5 px-5">
            <div class="d-flex justify-content-between small fw-bold text-muted mb-1">
                <span>OVERALL PROGRESS (Kits Packed)</span>
                {% set target_per_cam = activity.total_kits_to_pack %}
                {% set total_ops = target_per_cam * 2 %}
                {% set c1_done = [(activity.current_kit_index_cam1 - 1), target_per_cam] | min %}
                {% if c1_done < 0 %}{% set c1_done = 0 %}{% endif %}
                {% set c2_done = [(activity.current_kit_index_cam2 - 1), target_per_cam] | min %}
                {% if c2_done < 0 %}{% set c2_done = 0 %}{% endif %}
                {% set total_done = c1_done + c2_done %}
                {% if total_ops > 0 %}{% set percent = (total_done / total_ops * 100) | round | int %}{% else %}{% set percent = 0 %}{% endif %}
                <span class="text-dark">{{ percent }}%</span>
            </div>
            <div class="progress" style="height: 8px; border-radius: 4px;">
                <div class="progress-bar bg-success" style="width: {{ percent }}%"></div>
            </div>
        </div>
        <div class="col-md-4 d-flex justify-content-end gap-5">
            <div><div class="stat-label">PO Number</div><div class="stat-value">{{ activity.order_number }}</div></div>
            <div><div class="stat-label">Target Kits</div><div class="stat-value">Target: {{ activity.total_kits_to_pack }}</div></div>
        </div>
    </div>
</div>

<div class="row g-4 pb-5">
    {% for cam_name in ['cam1', 'cam2'] %}
    <div class="col-xl-6">
        <div class="cam-column h-100-card">
            
            {% set cam_index = activity.current_kit_index_cam1 if cam_name == 'cam1' else activity.current_kit_index_cam2 %}
            {% set is_cam_done = cam_index > activity.total_kits_to_pack %}

            <div class="cam-header">
                <div class="d-flex align-items-center gap-3">
                    <i class="fas fa-video fa-lg text-secondary"></i>
                    <h5 class="mb-0 fw-bold text-dark text-uppercase">{{ cam_name }}</h5>
                    <button class="btn btn-outline-primary btn-cam-history ms-2" onclick="openHistoryGrid('{{ cam_name }}')">
                        <i class="fas fa-history me-1"></i> History
                    </button>
                </div>
                <div class="small text-muted fw-bold">
                    {% if is_cam_done %}
                        <span class="badge bg-success text-white">ALL COMPLETED</span>
                    {% else %}
                        Kit #{{ cam_index }}
                    {% endif %}
                </div>
            </div>
            
            <div class="cam-body">
                {% if is_cam_done %}
                    <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted opacity-50 py-5">
                        <i class="fas fa-check-circle fa-4x mb-3"></i>
                        <h5>All Kits Packed</h5>
                        <p>Waiting for other station to finish.</p>
                    </div>
                {% else %}
                    <div class="section-header completed">
                        {% set completed_count = activity.components | selectattr('camera', 'equalto', cam_name) | selectattr('status', 'equalto', 'completed') | list | length %}
                        <span>Completed ({{ completed_count }})</span>
                    </div>
                    <div class="row g-3 mb-4">
                        {% for part in activity.components %}
                            {% if part.camera == cam_name and part.status == 'completed' %}
                            <div class="col-md-6">
                                <div class="part-card completed">
                                    <div class="order-badge">#{{ part.sequence_order }}</div>
                                    {% if cam_name == 'cam1' and activity.last_detected_index_cam1 == loop.index0 %}
                                        <div class="last-detected-badge">Last Detected</div>
                                    {% elif cam_name == 'cam2' and activity.last_detected_index_cam2 == loop.index0 %}
                                        <div class="last-detected-badge">Last Detected</div>
                                    {% endif %}
                                    <h5>{{ part.name }}</h5>
                                    <div class="part-qty text-primary fw-bold">Qty: {{ part.found_quantity }} / {{ part.quantity }}</div>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="section-header pending">
                        {% set pending_count = activity.components | selectattr('camera', 'equalto', cam_name) | selectattr('status', '!=', 'completed') | list | length %}
                        <span>Pending ({{ pending_count }})</span>
                    </div>
                    <div class="row g-3">
                        {% for part in activity.components %}
                            {% if part.camera == cam_name and part.status != 'completed' %}
                            <div class="col-md-6">
                                <div class="part-card pending">
                                    {% if cam_name == 'cam1' and activity.last_detected_index_cam1 == loop.index0 %}
                                        <div class="last-detected-badge">Last Detected</div>
                                    {% elif cam_name == 'cam2' and activity.last_detected_index_cam2 == loop.index0 %}
                                        <div class="last-detected-badge">Last Detected</div>
                                    {% endif %}
                                    <h5>{{ part.name }}</h5>
                                    <div class="part-qty">
                                        {% if part.found_quantity and part.found_quantity > 0 %}
                                            <span class="text-primary fw-bold">Qty: {{ part.found_quantity }} / {{ part.quantity }}</span>
                                        {% else %}
                                            Qty: 0 / {{ part.quantity }}
                                        {% endif %}
                                    </div>
                                    <i class="fas fa-exclamation-circle status-icon-pending text-warning position-absolute bottom-0 end-0 m-2"></i>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal fade" id="historyGridModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-4">
                
                <div id="grid-view">
                    <div id="grid-loading" class="text-center py-5 d-none"><div class="spinner-border text-primary"></div></div>
                    <div class="kit-grid" id="kit-grid-container"></div>
                    <div class="mt-4 d-flex gap-3 justify-content-center small text-muted">
                        <div class="d-flex align-items-center gap-1"><div class="rounded-circle bg-success" style="width:10px;height:10px;"></div> Match</div>
                        <div class="d-flex align-items-center gap-1"><div class="rounded-circle bg-warning" style="width:10px;height:10px;"></div> Over/Undercount</div>
                        <div class="d-flex align-items-center gap-1"><div class="rounded-circle bg-danger" style="width:10px;height:10px;"></div> Missing/Wrong</div>
                        <div class="d-flex align-items-center gap-1"><div class="rounded-circle bg-primary" style="width:10px;height:10px;"></div> In Progress</div>
                    </div>
                </div>

                <div id="detail-view" class="d-none">
                    <button class="btn btn-outline-secondary btn-sm mb-3" onclick="backToGrid()">Back</button>
                    
                    <div id="detail-validation-section" class="d-none mb-4">
                        <div class="card border-primary bg-primary-subtle">
                            <div class="card-body d-flex align-items-center gap-4">
                                <div class="bg-primary text-white p-3 rounded-circle"><i class="fas fa-camera fa-2x"></i></div>
                                <div>
                                    <h6 class="fw-bold text-primary mb-1">Validation Snapshot</h6>
                                    <p class="mb-0 small text-muted">Captured when kit was completed.</p>
                                </div>
                                <div id="detail-validation-img" class="ms-auto">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div id="detail-errors-section" class="d-none mb-4">
                        <h6 class="fw-bold text-danger border-bottom pb-2 mb-3"><i class="fas fa-exclamation-triangle me-2"></i> Errors & Anomalies</h6>
                        <div class="row g-3" id="detail-errors-row"></div>
                    </div>
                    
                    <div class="row g-3" id="detail-components-row"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const TABLE_ID = "{{ activity.table_id }}";
    const ACT_ID = "{{ activity._id }}";
    const socket = io(SOCKET_URL, { transports: ['websocket'], upgrade: false });
    
    let currentErrorType = null; 
    let currentErrorData = null; 
    let currentHistoryCam = null;
    let timers = { cam1: null, cam2: null }; 
    let pendingReloadTimer = null; 

    // --- HELPER: RESET OVERLAYS ---
    function resetOverlays() {
        if (pendingReloadTimer) { clearTimeout(pendingReloadTimer); pendingReloadTimer = null; }
        if (timers.cam1) { clearTimeout(timers.cam1); timers.cam1 = null; }
        if (timers.cam2) { clearTimeout(timers.cam2); timers.cam2 = null; }
        const ids = ['overlay-cam1', 'overlay-cam2', 'kit-error-overlay', 'job-completion-overlay', 'zoom-overlay'];
        ids.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
    }

    // --- ZOOM FUNCTIONS ---
    function openZoom(src) { document.getElementById('zoom-img').src = src; document.getElementById('zoom-overlay').style.display = 'flex'; }
    function closeZoom() { document.getElementById('zoom-overlay').style.display = 'none'; }

    socket.on('connect', () => { socket.emit('join_table', { table_id: TABLE_ID }); });

    socket.on('ui_update', (data) => {
        if (data.type === 'error_resolved') {
            resetOverlays(); window.location.reload(); return; 
        }
        if (data.type === 'error_alert' || data.type === 'validation_error') { 
            resetOverlays(); 
            // UPDATED: Both Red Screens can now accept data with imageUrl
            if (data.type === 'error_alert') showRedScreen('detection', data); 
            else showRedScreen('validation', data); 
            return; 
        }
        if (data.type === 'job_completed') { 
            resetOverlays(); document.getElementById('job-completion-overlay').style.display = 'flex'; 
            setTimeout(() => { window.location.href = "{{ url_for('kitting.index') }}"; }, 5000); 
            return; 
        }

        const rawCam = String(data.camId || (data.popup_data ? data.popup_data.camId : '')).toLowerCase();
        let targetCam = 'cam2'; if (rawCam.includes('1')) targetCam = 'cam1';
        const overlayId = `overlay-${targetCam}`;
        const overlay = document.getElementById(overlayId);
        if (timers[targetCam]) clearTimeout(timers[targetCam]);

        if (data.type === 'refresh_needed') {
            const p = data.popup_data;
            const imgUrl = p.imageUrl + "?t=" + new Date().getTime();
            overlay.className = `side-popup theme-green`; overlay.style.display = 'flex';
            overlay.innerHTML = `<div class="popup-img-container"><img src="${imgUrl}" alt="Detected"></div><div class="d-flex align-items-center justify-content-between w-100 p-2"><div class="d-flex align-items-center gap-3"><i class="fas fa-check-circle fa-3x popup-icon"></i><div><h6 class="opacity-75 fw-bold text-uppercase m-0 small ls-1">Detected</h6><h2 class="fw-bold m-0" style="font-size: 2.2rem;">${p.part_name}</h2></div></div><div class="popup-badge rounded-pill px-4 py-2 fw-bold fs-4 shadow-sm">Qty: ${p.found_qty} / ${p.required_qty}</div></div>`;
            timers[targetCam] = setTimeout(() => window.location.reload(), 2000);
        }
        else if (data.type === 'kit_completed' || data.type === 'kit_completed_with_warning') {
            const isWarning = (data.type === 'kit_completed_with_warning');
            const themeClass = isWarning ? 'theme-yellow' : 'theme-dark-green';
            const iconClass = isWarning ? 'fa-exclamation-triangle' : 'fa-box-open';
            const titleText = isWarning ? 'OVERCOUNT DETECTED' : 'KIT COMPLETED';
            
            overlay.className = `side-popup ${themeClass}`; overlay.style.display = 'flex';
            
            let contentHtml = `<div class="d-flex flex-column align-items-center justify-content-center h-100">
                <i class="fas ${iconClass} fa-6x mb-4 popup-icon"></i>
                <h1 class="fw-bold display-4 text-center">${titleText}</h1>
                <h3 class="opacity-75 text-uppercase">Kit #${data.completed_count}</h3>`;
            
            // --- UPDATED: Show Punch Machine Image if available ---
            if (data.imageUrl) {
                 contentHtml += `
                 <div class="mt-4 rounded overflow-hidden border shadow-sm bg-white" style="max-height: 250px; width: 80%; display: flex; align-items: center; justify-content: center;">
                    <img src="${data.imageUrl}" style="max-width: 100%; max-height: 250px; object-fit: contain;">
                 </div>`;
            }

            if (isWarning && data.overcount_list) { 
                contentHtml += `<div class="mt-4 bg-white text-dark p-3 rounded shadow-sm text-start" style="min-width: 300px;"><h6 class="border-bottom pb-2 mb-2 fw-bold text-warning">Extra Parts:</h6><ul class="mb-0 ps-3">`; 
                data.overcount_list.forEach(item => { contentHtml += `<li>${item}</li>`; }); 
                contentHtml += `</ul></div>`; 
            }
            contentHtml += `</div>`;
            overlay.innerHTML = contentHtml;
            timers[targetCam] = setTimeout(() => window.location.reload(), 4000);
        }
    });

    // --- UPDATED: RED SCREEN LOGIC TO SHOW VALIDATION IMAGES ---
    function showRedScreen(type, data) {
        currentErrorType = type; currentErrorData = data; 
        const overlay = document.getElementById('kit-error-overlay');
        document.getElementById('err-title').innerText = type === 'detection' ? "WRONG PART DETECTED" : "VALIDATION FAILED";
        
        let contentHtml = '';
        
        // --- NEW: Common Image Logic for BOTH types ---
        let imgHtml = '';
        if (data.imageUrl) {
             imgHtml = `<div class="text-center mt-3"><img src="${data.imageUrl}" class="img-fluid rounded border shadow-sm" style="max-height: 200px; object-fit: contain; background: #fff;"></div>`;
        }

        if (type === 'detection') {
            contentHtml = `<div class="text-center"><h4 class="fw-bold text-dark">${data.detectedPart}</h4></div>`;
        } else {
            contentHtml = '<ul class="list-group list-group-flush text-start">';
            [...data.missing, ...data.undercount].forEach(item => contentHtml += `<li class="list-group-item list-group-item-danger">Missing: <strong>${item}</strong></li>`);
            if(data.overcount) contentHtml += `<li class="list-group-item list-group-item-warning">Overcount: ${data.overcount.join(', ')}</li>`;
            contentHtml += '</ul>';
        }
        
        // Append Image Logic
        contentHtml += imgHtml;

        document.getElementById('err-content').innerHTML = contentHtml;
        const select = document.getElementById('err-reason');
        select.innerHTML = '<option value="" disabled selected>-- Choose Action --</option>';
        ["Trash Removed", "Operator Override", "System Error"].forEach(r => select.innerHTML += `<option value="${r}">${r}</option>`);
        overlay.style.display = 'flex';
    }

    async function submitResolution() {
        const reason = document.getElementById('err-reason').value;
        if (!reason) { alert("Please select a reason."); return; }
        if (!currentErrorData.camId) { currentErrorData.camId = 'cam1'; }
        try { 
            await fetch(`/kitting/api/${TABLE_ID}/resolve_error`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ error_type: currentErrorType, reason: reason, error_details: currentErrorData }) }); 
            document.getElementById('kit-error-overlay').style.display = 'none'; 
        } catch (e) { console.error(e); alert("Error submitting resolution."); }
    }

    function openHistoryGrid(camId) {
        currentHistoryCam = camId;
        document.getElementById('grid-view').classList.remove('d-none');
        document.getElementById('detail-view').classList.add('d-none');
        document.getElementById('modalTitle').innerText = `History for ${camId.toUpperCase()}`;
        new bootstrap.Modal(document.getElementById('historyGridModal')).show();
        fetchGridData(camId);
    }
    async function fetchGridData(camId) {
        const loader = document.getElementById('grid-loading');
        const container = document.getElementById('kit-grid-container');
        container.innerHTML = ''; loader.classList.remove('d-none');
        try {
            const res = await fetch(`/kitting/api/history_summary/${ACT_ID}/${camId}`);
            const data = await res.json();
            loader.classList.add('d-none');
            if (data.status === 'success') {
                data.grid.forEach(kit => {
                    const div = document.createElement('div');
                    div.className = `kit-cell kit-${kit.color}`;
                    div.innerText = kit.kit_number;
                    if (kit.state === 'completed') div.onclick = () => loadKitDetails(kit.kit_number);
                    else div.style.cursor = 'default';
                    container.appendChild(div);
                });
            }
        } catch(e) { console.error(e); loader.classList.add('d-none'); }
    }
    function backToGrid() {
        document.getElementById('detail-view').classList.add('d-none');
        document.getElementById('grid-view').classList.remove('d-none');
    }
    
    // --- UPDATED: RENDER IMAGE GRID & ERRORS & VALIDATION IMAGE ---
    async function loadKitDetails(kitNum) {
        document.getElementById('grid-view').classList.add('d-none');
        document.getElementById('detail-view').classList.remove('d-none');
        
        try {
            const res = await fetch(`/kitting/api/history/${ACT_ID}/${currentHistoryCam}/${kitNum}`);
            const data = await res.json();
            
            const compRow = document.getElementById('detail-components-row');
            const errRow = document.getElementById('detail-errors-row');
            const errSection = document.getElementById('detail-errors-section');
            const valSection = document.getElementById('detail-validation-section');
            const valImgDiv = document.getElementById('detail-validation-img');
            
            compRow.innerHTML = ''; errRow.innerHTML = '';

            if(data.status === 'success') {
                
                // --- 0. Render Validation (Punch) Image if exists ---
                // "validation_image_url" comes from our updated backend history structure
                if (data.validation_image_url || (data.errors && data.errors.some(e => e.error_type === 'validation'))) {
                    // Try to find image in root or inside errors
                    let vUrl = data.validation_image_url;
                    
                    if(vUrl) {
                        valSection.classList.remove('d-none');
                        valImgDiv.innerHTML = `<img src="${vUrl}" class="rounded border shadow-sm" style="height: 100px; cursor: zoom-in;" onclick="openZoom('${vUrl}')">`;
                    } else {
                        valSection.classList.add('d-none');
                    }
                } else {
                    valSection.classList.add('d-none');
                }

                // --- 1. Render Components ---
                data.components.forEach(part => {
                    let statusClass = 'border-success'; 
                    if (part.found_quantity == 0) statusClass = 'border-danger';
                    else if (part.found_quantity != part.quantity) statusClass = 'border-warning';
                    
                    let html = `
                    <div class="col-md-6">
                        <div class="history-card ${statusClass}">
                            <div class="history-card-header">
                                <div><div class="small fw-bold text-muted">PART:</div><strong>${part.name}</strong></div>
                                <span class="badge ${part.found_quantity >= part.quantity ? 'bg-success' : 'bg-warning text-dark'}">${part.found_quantity}/${part.quantity}</span>
                            </div>
                            <div class="history-img-grid">
                    `;
                    
                    const images = (part.captured_images && part.captured_images.length > 0) ? part.captured_images : (part.last_image_url ? [part.last_image_url] : []);
                    
                    if (images.length > 0) {
                        images.forEach((imgItem, idx) => {
                             let src = "";
                             let badgeInfo = "";

                             if (typeof imgItem === 'string') {
                                 src = imgItem;
                             } else if (imgItem && imgItem.image_url) {
                                 src = imgItem.image_url;
                                 if (imgItem.confidence) {
                                     const pct = Math.round(imgItem.confidence * 100);
                                     badgeInfo = ` (${pct}%)`;
                                 }
                             }
                             if (src) {
                                html += `
                                    <div class="history-img-item" onclick="openZoom('${src}')">
                                        <div class="img-badge">Img ${idx + 1}${badgeInfo}</div>
                                        <img src="${src}">
                                    </div>
                                `;
                             }
                        });
                    } else {
                        html += `<div class="p-3 text-muted small text-center w-100">No images captured</div>`;
                    }
    
                    html += `</div></div></div>`;
                    compRow.innerHTML += html;
                });
    
                // 2. Render Errors (UPDATED)
                if (data.errors && data.errors.length > 0) {
                    errSection.classList.remove('d-none');
                    errRow.innerHTML = ''; // Clear previous

                    data.errors.forEach(err => {
                        const details = err.error_details || {};
                        const reason = err.reason_selected || err.reason || 'Pending Resolution';
                        
                        // --- A. Determine Badge & Title based on Error Type ---
                        let badgeText = "WRONG PART";
                        let titleText = "Unknown Object";
                        let badgeClass = "bg-danger"; // Red by default

                        if (err.error_type === 'validation') {
                            // CASE: Punch Machine Validation Failure
                            badgeText = "MISSING PARTS";
                            badgeClass = "bg-warning text-dark"; // Yellow/Orange for visibility
                            
                            // Build list of missing items
                            let missingItems = [];
                            if (details.missing && details.missing.length > 0) missingItems.push(...details.missing);
                            if (details.undercount && details.undercount.length > 0) missingItems.push(...details.undercount);
                            
                            titleText = missingItems.length > 0 ? missingItems.join(", ") : "Validation Failed";
                        } else {
                            // CASE: Wrong Part Detection
                            titleText = details.detectedPart || details.detected_part || details.AiDetectedPartName || 'Unknown Object';
                        }

                        // --- B. Handle Image ---
                        let imgHtml = '';
                        if (details.imageUrl) {
                            imgHtml = `<img src="${details.imageUrl}" class="rounded mt-2 border" style="height:100px; width:100%; object-fit:contain; background:#fff; cursor:zoom-in" onclick="openZoom('${details.imageUrl}')">`;
                        }

                        // --- C. Render HTML ---
                        errRow.innerHTML += `
                            <div class="col-md-4">
                                <div class="p-3 rounded border border-danger bg-danger-subtle h-100">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="badge ${badgeClass}">${badgeText}</span>
                                        <small class="text-danger fw-bold">${new Date(err.timestamp).toLocaleTimeString()}</small>
                                    </div>
                                    <h6 class="fw-bold text-danger mb-1" style="word-break: break-word;">${titleText}</h6>
                                    <div class="small text-muted mb-2"><strong>Resolution:</strong> ${reason}</div>
                                    ${imgHtml}
                                </div>
                            </div>`;
                    });
                } else { 
                    errSection.classList.add('d-none'); 
                }
            }
        } catch (e) {
            console.error("Error loading kit details:", e);
            alert("Failed to load history details.");
        }
    }

    // --- STATE HYDRATION ---
    (function checkInitialState() {
        console.log("üîÑ Checking initial state from DB...");
        
        const errorsC1 = {{ (activity.current_kit_errors_cam1 or []) | tojson }};
        const errorsC2 = {{ (activity.current_kit_errors_cam2 or []) | tojson }};
        
        let activeError = null;
        if (Array.isArray(errorsC1) && errorsC1.length > 0) { activeError = errorsC1[errorsC1.length - 1]; } 
        else if (Array.isArray(errorsC2) && errorsC2.length > 0) { activeError = errorsC2[errorsC2.length - 1]; }

        if (activeError) {
            console.warn("‚ö†Ô∏è Active Error Found on Load:", activeError);
            resetOverlays();
            
            // Re-use logic: 'validation' errors might now have images
            if (activeError.error_type === 'detection') {
                showRedScreen('detection', activeError.error_details);
            } else if (activeError.error_type === 'validation') {
                showRedScreen('validation', activeError.error_details);
            }
        }
    })();
</script>
{% endblock %}