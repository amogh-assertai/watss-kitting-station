{% extends "base.html" %}

{% block container_class %}container-fluid px-4{% endblock %}

{% block content %}
<style>
    /* --- EXISTING STYLES --- */
    :root { --pending-header-bg: #eef2ff; --pending-header-text: #4f46e5; --pending-border: #6366f1; --completed-header-bg: #d1fae5; --completed-header-text: #065f46; --completed-border: #10b981; --completed-bg: #ecfdf5; --text-dark: #1f2937; --text-muted: #6b7280; }
    .monitor-header { background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px 30px; margin-bottom: 25px; border: 1px solid #e5e7eb; }
    .stat-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; }
    .stat-value { font-size: 1.125rem; font-weight: 700; color: var(--text-dark); }
    .cam-column { background: #fff; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; height: 100%; display: flex; flex-direction: column; }
    .cam-header { padding: 20px 25px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
    .cam-body { padding: 20px; flex-grow: 1; background-color: #f9fafb; }
    .section-header { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; display: flex; justify-content: space-between; }
    .section-header.completed { background-color: var(--completed-header-bg); color: var(--completed-header-text); border: 1px solid #a7f3d0; }
    .section-header.pending { background-color: var(--pending-header-bg); color: var(--pending-header-text); border: 1px solid #c7d2fe; }
    
    .part-card { background: white; border-radius: 8px; padding: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; min-height: 90px; }
    .part-card.pending { border-left: 5px solid var(--pending-border); }
    .part-card.completed { background-color: var(--completed-bg); border: 1px solid var(--completed-border); border-left: 5px solid var(--completed-border); }
    
    .order-badge { position: absolute; top: 0; left: 0; background: var(--completed-border); color: white; font-size: 0.75rem; font-weight: 800; padding: 2px 8px; border-bottom-right-radius: 8px; }
    
    /* Last Detected Badge */
    .last-detected-badge { position: absolute; bottom: 0; right: 0; background: #32325d; color: white; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; padding: 3px 10px; border-top-left-radius: 8px; animation: flashBadge 1s infinite alternate; }
    @keyframes flashBadge { from { opacity: 0.8; } to { opacity: 1; } }

    /* POPUP */
    #success-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(16, 185, 129, 0.92); z-index: 9999; color: white; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .success-content { background: white; color: #333; padding: 30px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-width: 450px; width: 90%; }
    .h-100-card { height: 100%; min-height: 70vh; }
</style>

<div id="success-popup">
    <div class="success-content">
        <div class="mb-2 text-success"><i class="fas fa-check-circle fa-5x"></i></div>
        <h2 class="fw-bold text-success mb-1">PART DETECTED</h2>
        <h4 class="fw-bold text-dark" id="popup-part-name">Part Name</h4>
        <div class="badge bg-secondary mb-3 fs-6" id="popup-qty">Qty: 1/1</div>
        <div class="border rounded p-1 d-inline-block bg-light">
            <img id="popup-image" src="" style="height: 180px; width: auto; max-width: 100%; object-fit: contain; border-radius: 8px;">
        </div>
    </div>
</div>

<div class="monitor-header">
    <div class="row align-items-center">
        <div class="col-md-3 d-flex align-items-center gap-3">
            <a href="{{ url_for('kitting.index') }}" class="btn btn-outline-secondary btn-sm border-0 fw-bold"><i class="fas fa-arrow-left me-1"></i> Back</a>
            <span class="badge rounded-pill bg-success px-3 py-2 text-uppercase">{{ activity.status }}</span>
        </div>
        <div class="col-md-5 px-5">
            <div class="d-flex justify-content-between small fw-bold text-muted mb-1">
                <span>OVERALL PROGRESS (Job)</span>
                
                {# --- FIXED MATH LOGIC --- #}
                {% set parts_per_kit = activity.components|length %}
                {% set total_job_parts = parts_per_kit * activity.total_kits_to_pack %}
                
                {# Parts done in previous kits + parts done in current kit #}
                {% set completed_in_current = activity.components|selectattr('status','equalto','completed')|list|length %}
                {% set parts_done_historically = ((activity.current_kit_index - 1) * parts_per_kit) %}
                {% set total_done = parts_done_historically + completed_in_current %}

                {# Calculate % #}
                {% set percent = (total_done / total_job_parts * 100)|round|int if total_job_parts > 0 else 0 %}
                
                <span class="text-dark">{{ percent }}%</span>
            </div>
            <div class="progress" style="height: 8px; border-radius: 4px;">
                <div class="progress-bar bg-success" style="width: {{ percent }}%"></div>
            </div>
        </div>
        <div class="col-md-4 d-flex justify-content-end gap-5">
            <div><div class="stat-label">PO Number</div><div class="stat-value">{{ activity.order_number }}</div></div>
            <div><div class="stat-label">Target Kits</div><div class="stat-value">{{ activity.current_kit_index - 1 }} / {{ activity.total_kits_to_pack }}</div></div>
        </div>
    </div>
</div>

<div class="row g-4 pb-5">
    {% for cam_name in ['cam1', 'cam2'] %}
    <div class="col-xl-6">
        <div class="cam-column h-100-card">
            <div class="cam-header">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-video fa-lg text-secondary"></i>
                    <h5 class="mb-0 fw-bold text-dark text-uppercase">{{ cam_name }}</h5>
                </div>
                <div class="small text-muted fw-bold">Kit #{{ activity.current_kit_index }}</div>
            </div>
            <div class="cam-body">
                
                <div class="section-header completed">
                    {% set completed_count = activity.components | selectattr('camera', 'equalto', cam_name) | selectattr('status', 'equalto', 'completed') | list | length %}
                    <span>Completed ({{ completed_count }})</span>
                </div>
                <div class="row g-3 mb-4">
                    {# FIX: Loop through MAIN list to preserve loop.index0, but use IF to filter #}
                    {% for part in activity.components %}
                        {% if part.camera == cam_name and part.status == 'completed' %}
                        <div class="col-md-6">
                            <div class="part-card completed">
                                <div class="order-badge">#{{ part.sequence_order }}</div>
                                
                                {# Correct Index Check #}
                                {% if activity.last_detected_index == loop.index0 %}
                                    <div class="last-detected-badge">Last Detected</div>
                                {% endif %}

                                <h5>{{ part.name }}</h5>
                                <div class="part-qty text-primary fw-bold">Qty: {{ part.found_quantity }} / {{ part.quantity }}</div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <div class="section-header pending">
                    {% set pending_count = activity.components | selectattr('camera', 'equalto', cam_name) | selectattr('status', '!=', 'completed') | list | length %}
                    <span>Pending ({{ pending_count }})</span>
                </div>
                <div class="row g-3">
                    {# FIX: Loop through MAIN list again, filter for pending #}
                    {% for part in activity.components %}
                        {% if part.camera == cam_name and part.status != 'completed' %}
                        <div class="col-md-6">
                            <div class="part-card pending">
                                
                                {# Correct Index Check #}
                                {% if activity.last_detected_index == loop.index0 %}
                                    <div class="last-detected-badge">Last Detected</div>
                                {% endif %}

                                <h5>{{ part.name }}</h5>
                                <div class="part-qty">
                                    {% if part.found_quantity and part.found_quantity > 0 %}
                                        <span class="text-primary fw-bold">Qty: {{ part.found_quantity }} / {{ part.quantity }}</span>
                                    {% else %}
                                        Qty: 0 / {{ part.quantity }}
                                    {% endif %}
                                </div>
                                <i class="fas fa-exclamation-circle status-icon-pending text-warning position-absolute bottom-0 end-0 m-2"></i>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const TABLE_ID = "{{ activity.table_id }}";
    const socket = io(SOCKET_URL, { transports: ['websocket'], upgrade: false });

    socket.on('connect', () => {
        console.log("✅ Monitor Connected");
        socket.emit('join_table', { table_id: TABLE_ID });
    });

    socket.on('ui_update', (data) => {
        if (data.type === 'refresh_needed') {
            const p = data.popup_data;
            document.getElementById('popup-part-name').innerText = p.part_name;
            document.getElementById('popup-qty').innerText = `Qty: ${p.found_qty} / ${p.required_qty}`;
            document.getElementById('popup-image').src = p.imageUrl + "?t=" + new Date().getTime();
            document.getElementById('success-popup').style.display = 'flex';

            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } 
        else if (data.type === 'error_alert') {
            alert("⚠️ Wrong Part Detected: " + data.detectedPart);
        }
    });
</script>
{% endblock %}