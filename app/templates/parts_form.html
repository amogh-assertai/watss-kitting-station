{% extends "base.html" %}

{% block content %}
<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-cogs"></i> {{ 'Edit Kit' if kit else 'Create New Kit' }}
        </h2>
        <a href="{{ url_for('parts.list_kits') }}" class="btn btn-outline-secondary">Back to List</a>
    </div>

    <input type="hidden" id="kit_id" value="{{ kit.id if kit else '' }}">

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light fw-bold">1. Kit Details</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Kit Name</label>
                    <input type="text" class="form-control" id="kit_name" value="{{ kit.kit_name if kit else '' }}" placeholder="e.g. Engine Assembly Kit A">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">EDP Number</label>
                    <input type="text" class="form-control" id="edp_number" value="{{ kit.edp_number if kit else '' }}" placeholder="e.g. EDP-998877">
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <span class="fw-bold">2. Parts Configuration</span>
            <button type="button" class="btn btn-sm btn-success" onclick="addPartRow()">
                <i class="fas fa-plus"></i> Add Part
            </button>
        </div>
        <div class="card-body p-0">
            <table class="table table-bordered mb-0" id="partsTable">
                <thead class="table-light">
                    <tr>
                        <th style="width: 25%">Part Name</th>
                        <th style="width: 15%">Qty</th>
                        <th style="width: 15%">Camera</th>
                        <th style="width: 35%">Alert Config</th>
                        <th style="width: 10%">Action</th>
                    </tr>
                </thead>
                <tbody id="partsBody">
                    </tbody>
            </table>
            
            <div id="emptyState" class="text-center py-4 text-muted">
                No parts added yet. Click "Add Part" to begin.
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button type="button" class="btn btn-primary btn-lg px-5" onclick="submitKit()">
            <i class="fas fa-save"></i> Save Kit Configuration
        </button>
    </div>
</div>

<script>
    // Load existing parts if editing
    const existingParts = {{ kit.parts | tojson if kit and kit.parts else '[]' | safe }};

    document.addEventListener('DOMContentLoaded', () => {
        if (existingParts.length > 0) {
            existingParts.forEach(part => addPartRow(part));
        }
    });

    function addPartRow(data = null) {
        document.getElementById('emptyState').style.display = 'none';
        const tbody = document.getElementById('partsBody');
        const rowId = Date.now() + Math.floor(Math.random() * 1000); 

        // Default values
        const name = data ? data.name : '';
        const qty = data ? data.quantity : 1;
        const cam = data ? data.camera : 'cam1';
        
        // --- LOGIC CHANGE: Handle Boolean Flags ---
        // 1. Check if 'alert_missing' boolean exists (New Format)
        // 2. Fallback: Check if 'missing' is in 'alerts' array (Old Format)
        // 3. Default: false
        
        const isMissing = data ? (data.alert_missing === true || (data.alerts && data.alerts.includes('missing'))) : false;
        const isUndercount = data ? (data.alert_undercount === true || (data.alerts && data.alerts.includes('undercount'))) : false;
        const isOvercount = data ? (data.alert_overcount === true || (data.alerts && data.alerts.includes('overcount'))) : false;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="text" class="form-control part-name" placeholder="Part Name" value="${name}">
            </td>
            <td>
                <input type="number" class="form-control part-qty" min="1" value="${qty}">
            </td>
            <td>
                <select class="form-select part-cam">
                    <option value="cam1" ${cam === 'cam1' ? 'selected' : ''}>Camera 1</option>
                    <option value="cam2" ${cam === 'cam2' ? 'selected' : ''}>Camera 2</option>
                </select>
            </td>
            <td>
                <div class="d-flex flex-column gap-1">
                    <div class="form-check">
                        <input class="form-check-input part-alert-missing" type="checkbox" id="miss_${rowId}" ${isMissing ? 'checked' : ''}>
                        <label class="form-check-label text-danger" for="miss_${rowId}">Alert if Missing</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input part-alert-undercount" type="checkbox" id="under_${rowId}" ${isUndercount ? 'checked' : ''}>
                        <label class="form-check-label text-warning" for="under_${rowId}">Alert if Undercount</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input part-alert-overcount" type="checkbox" id="over_${rowId}" ${isOvercount ? 'checked' : ''}>
                        <label class="form-check-label text-info" for="over_${rowId}">Alert if Overcount</label>
                    </div>
                </div>
            </td>
            <td class="text-center align-middle">
                <button class="btn btn-outline-danger btn-sm" onclick="removeRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        if(document.getElementById('partsBody').children.length === 0) {
            document.getElementById('emptyState').style.display = 'block';
        }
    }

    async function submitKit() {
        // 1. Gather Basic Info
        const kitId = document.getElementById('kit_id').value;
        const kitName = document.getElementById('kit_name').value;
        const edpNumber = document.getElementById('edp_number').value;

        if(!kitName || !edpNumber) {
            alert("Please fill in Kit Name and EDP Number");
            return;
        }

        // 2. Gather Parts Data
        const rows = document.querySelectorAll('#partsBody tr');
        let parts = [];
        
        for (let row of rows) {
            const name = row.querySelector('.part-name').value;
            const qty = row.querySelector('.part-qty').value;
            const cam = row.querySelector('.part-cam').value;
            
            // --- LOGIC CHANGE: Grab Checkboxes directly as Booleans ---
            const alertMissing = row.querySelector('.part-alert-missing').checked;
            const alertUndercount = row.querySelector('.part-alert-undercount').checked;
            const alertOvercount = row.querySelector('.part-alert-overcount').checked;

            if(!name) {
                alert("All parts must have a name.");
                return;
            }

            parts.push({
                name: name,
                quantity: parseInt(qty),
                camera: cam,
                // Saving explicit booleans to DB
                alert_missing: alertMissing,
                alert_undercount: alertUndercount,
                alert_overcount: alertOvercount
            });
        }

        // 3. Send to Server
        const payload = {
            kit_id: kitId,
            kit_name: kitName,
            edp_number: edpNumber,
            parts: parts
        };

        try {
            const response = await fetch("{{ url_for('parts.save_kit') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            if (result.status === 'success') {
                window.location.href = result.redirect;
            } else {
                alert("Error: " + result.message);
            }
        } catch (error) {
            console.error("Error:", error);
            alert("An unexpected error occurred.");
        }
    }
</script>
{% endblock %}